<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLB模型查看器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Three.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <!-- GLTF加载器 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
    <!-- 轨道控制器，用于交互 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#10B981',
                        dark: '#1E293B',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .model-container {
                @apply relative w-full bg-gray-900 rounded-lg overflow-hidden shadow-2xl;
            }
            .control-btn {
                @apply w-10 h-10 rounded-full flex items-center justify-center text-white 
                       bg-dark/70 backdrop-blur-sm transition-all duration-300 
                       hover:bg-primary hover:scale-110 active:scale-95;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-gray-800 mb-2">
                GLB模型查看器
            </h1>
            <p class="text-gray-600">加载和交互式展示3D模型文件</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 3D模型展示区域 -->
            <div class="lg:col-span-3">
                <div id="modelContainer" class="model-container aspect-[4/3]">
                    <!-- 加载指示器 -->
                    <div id="loadingIndicator" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/80 z-10">
                        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p class="text-white text-lg">加载模型中...</p>
                        <p id="loadingProgress" class="text-gray-300 text-sm mt-2">0%</p>
                    </div>
                    
                    <!-- 错误提示 -->
                    <div id="errorMessage" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/80 z-10 hidden">
                        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <p class="text-white text-lg mb-2">加载失败</p>
                        <p id="errorDetails" class="text-gray-300 text-sm text-center max-w-md"></p>
                    </div>
                </div>
                
                <!-- 模型信息 -->
                <div id="modelInfo" class="mt-4 bg-white p-4 rounded-lg shadow-md hidden">
                    <h2 class="font-semibold text-gray-800 mb-2">模型信息</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        <div>
                            <p class="text-gray-500">名称</p>
                            <p id="modelName" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500">顶点数</p>
                            <p id="vertexCount" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500">面数</p>
                            <p id="faceCount" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500">大小</p>
                            <p id="modelSize" class="font-medium">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 控制面板 -->
            <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-md">
                <h2 class="font-semibold text-gray-800 mb-4">控制选项</h2>
                
                <!-- 模型文件上传 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        上传GLB模型
                    </label>
                    <div class="relative">
                        <input type="file" id="modelFile" accept=".glb,.gltf" 
                               class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-primary transition-colors">
                            <i class="fa fa-cloud-upload text-gray-400 text-xl mb-2"></i>
                            <p class="text-sm text-gray-500">点击或拖拽文件到此处</p>
                            <p class="text-xs text-gray-400 mt-1">支持 .glb 和 .gltf 格式</p>
                        </div>
                    </div>
                </div>
                
                <!-- 示例模型 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        加载示例模型
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <button data-model="https://threejs.org/examples/models/gltf/DamagedHelmet/glTF-Binary/DamagedHelmet.glb" 
                                class="example-model-btn px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded transition-colors">
                            头盔
                        </button>
                        <button data-model="https://threejs.org/examples/models/gltf/LittlestTokyo.glb" 
                                class="example-model-btn px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded transition-colors">
                            建筑
                        </button>
                    </div>
                </div>
                
                <!-- 视图控制 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        视图控制
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button id="rotateBtn" class="control-btn">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="resetViewBtn" class="control-btn">
                            <i class="fa fa-home"></i>
                        </button>
                        <button id="wireframeBtn" class="control-btn">
                            <i class="fa fa-th"></i>
                        </button>
                        <button id="fullscreenBtn" class="control-btn">
                            <i class="fa fa-expand"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 环境设置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        环境设置
                    </label>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">背景颜色</label>
                            <input type="color" id="bgColorPicker" value="#000000" 
                                   class="w-full h-8 cursor-pointer rounded border border-gray-300">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">缩放</label>
                            <input type="range" id="scaleSlider" min="0.1" max="5" step="0.1" value="1"
                                   class="w-full accent-primary">
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 使用说明 -->
        <div class="mt-8 bg-white p-4 rounded-lg shadow-md">
            <h2 class="font-semibold text-gray-800 mb-2">操作说明</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-700"><i class="fa fa-mouse-pointer text-primary mr-2"></i> 左键拖动：旋转模型</p>
                    <p class="text-gray-700"><i class="fa fa-search text-primary mr-2"></i> 滚轮：缩放模型</p>
                    <p class="text-gray-700"><i class="fa fa-arrows text-primary mr-2"></i> 右键拖动：平移视图</p>
                </div>
                <div>
                    <p class="text-gray-700"><i class="fa fa-refresh text-primary mr-2"></i> 旋转按钮：自动旋转模型</p>
                    <p class="text-gray-700"><i class="fa fa-home text-primary mr-2"></i> 重置按钮：恢复初始视图</p>
                    <p class="text-gray-700"><i class="fa fa-th text-primary mr-2"></i> 线框按钮：切换线框模式</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let scene, camera, renderer, controls;
        let model, originalModelPosition;
        let isRotating = false;
        let rotationInterval;
        let currentModelUrl = '';
        
        // DOM元素
        const modelContainer = document.getElementById('modelContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingProgress = document.getElementById('loadingProgress');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const modelInfo = document.getElementById('modelInfo');
        const modelName = document.getElementById('modelName');
        const vertexCount = document.getElementById('vertexCount');
        const faceCount = document.getElementById('faceCount');
        const modelSize = document.getElementById('modelSize');
        const modelFile = document.getElementById('modelFile');
        const rotateBtn = document.getElementById('rotateBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');
        const wireframeBtn = document.getElementById('wireframeBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const bgColorPicker = document.getElementById('bgColorPicker');
        const scaleSlider = document.getElementById('scaleSlider');
        const exampleModelBtns = document.querySelectorAll('.example-model-btn');
        
        // 初始化Three.js场景
        function initThreeJS() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(75, modelContainer.clientWidth / modelContainer.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(modelContainer.clientWidth, modelContainer.clientHeight);
            renderer.shadowMap.enabled = true;
            modelContainer.appendChild(renderer.domElement);
            
            // 添加环境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            // 添加方向光
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 添加辅助网格
            const gridHelper = new THREE.GridHelper(10, 10, 0x333333, 0x222222);
            scene.add(gridHelper);
            
            // 添加轨道控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = false;
            
            // 处理窗口大小变化
            window.addEventListener('resize', onWindowResize);
            
            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            console.log('Three.js 初始化完成');
        }
        
        // 窗口大小变化处理
        function onWindowResize() {
            if (!camera || !renderer) return;
            
            const width = modelContainer.clientWidth;
            const height = modelContainer.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }
        
        // 加载GLB模型
        function loadGLBModel(url, fileSize = null) {
            // 重置状态
            if (model) {
                scene.remove(model);
                model = null;
            }
            
            // 显示加载指示器
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            modelInfo.classList.add('hidden');
            loadingProgress.textContent = '0%';
            currentModelUrl = url;
            
            // 创建GLTF加载器
            const loader = new THREE.GLTFLoader();
            
            // 加载进度回调
            loader.onProgress = function(xhr) {
                const percent = Math.round((xhr.loaded / xhr.total) * 100);
                loadingProgress.textContent = `${percent}%`;
            };
            
            // 加载完成回调
            loader.load(
                url,
                (gltf) => {
                    // 隐藏加载指示器
                    loadingIndicator.classList.add('hidden');
                    
                    // 保存模型引用
                    model = gltf.scene;
                    
                    // 计算模型尺寸并居中
                    centerModel(model);
                    
                    // 添加模型到场景
                    scene.add(model);
                    
                    // 更新模型信息
                    updateModelInfo(gltf, fileSize);
                    
                    // 显示模型信息
                    modelInfo.classList.remove('hidden');
                    
                    console.log('模型加载成功', gltf);
                },
                null, // 进度回调已在上面设置
                (error) => {
                    // 显示错误信息
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    errorDetails.textContent = `加载模型时发生错误: ${error.message}`;
                    console.error('模型加载失败', error);
                }
            );
        }
        
        // 居中模型并调整相机
        function centerModel(model) {
            // 计算模型边界
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // 居中模型
            model.position.sub(center);
            originalModelPosition = model.position.clone();
            
            // 调整相机位置以完整显示模型
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
            cameraZ *= 1.5; // 增加一些距离
            camera.position.z = cameraZ;
            
            // 调整控制器目标
            controls.target.set(0, 0, 0);
            controls.update();
        }
        
        // 更新模型信息
        function updateModelInfo(gltf, fileSize) {
            // 模型名称
            modelName.textContent = gltf.asset?.generator || '未知模型';
            
            // 计算顶点数和面数
            let vertices = 0;
            let faces = 0;
            
            model.traverse(function(child) {
                if (child.isMesh) {
                    vertices += child.geometry.attributes.position.count;
                    faces += child.geometry.index ? child.geometry.index.count / 3 : 0;
                }
            });
            
            vertexCount.textContent = vertices.toLocaleString();
            faceCount.textContent = Math.round(faces).toLocaleString();
            
            // 模型大小
            if (fileSize) {
                const sizeText = fileSize < 1024 * 1024 
                    ? `${(fileSize / 1024).toFixed(1)} KB` 
                    : `${(fileSize / (1024 * 1024)).toFixed(2)} MB`;
                modelSize.textContent = sizeText;
            } else {
                modelSize.textContent = '未知';
            }
        }
        
        // 事件监听
        function setupEventListeners() {
            // 文件上传
            modelFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    if (fileExtension !== 'glb' && fileExtension !== 'gltf') {
                        alert('请上传 .glb 或 .gltf 格式的模型文件');
                        return;
                    }
                    
                    const url = URL.createObjectURL(file);
                    loadGLBModel(url, file.size);
                }
            });
            
            // 示例模型
            exampleModelBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modelUrl = this.getAttribute('data-model');
                    loadGLBModel(modelUrl);
                });
            });
            
            // 旋转控制
            rotateBtn.addEventListener('click', function() {
                isRotating = !isRotating;
                
                if (isRotating) {
                    this.classList.add('bg-primary');
                    controls.autoRotate = true;
                    controls.autoRotateSpeed = 2;
                } else {
                    this.classList.remove('bg-primary');
                    controls.autoRotate = false;
                }
            });
            
            // 重置视图
            resetViewBtn.addEventListener('click', function() {
                if (model) {
                    model.position.copy(originalModelPosition);
                    model.rotation.set(0, 0, 0);
                    model.scale.set(1, 1, 1);
                    scaleSlider.value = 1;
                }
                controls.reset();
            });
            
            // 线框模式
            wireframeBtn.addEventListener('click', function() {
                if (!model) return;
                
                this.classList.toggle('bg-primary');
                const isWireframe = this.classList.contains('bg-primary');
                
                model.traverse(function(child) {
                    if (child.isMesh) {
                        child.material.wireframe = isWireframe;
                    }
                });
            });
            
            // 全屏切换
            fullscreenBtn.addEventListener('click', function() {
                if (!document.fullscreenElement) {
                    modelContainer.requestFullscreen().catch(err => {
                        console.error(`全屏请求失败: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
            
            // 背景颜色
            bgColorPicker.addEventListener('input', function() {
                scene.background = new THREE.Color(this.value);
            });
            
            // 缩放控制
            scaleSlider.addEventListener('input', function() {
                if (model) {
                    const scale = parseFloat(this.value);
                    model.scale.set(scale, scale, scale);
                }
            });
        }
        
        // 初始化
        window.addEventListener('load', function() {
            initThreeJS();
            setupEventListeners();
            
            // 默认加载一个示例模型
            loadGLBModel('https://threejs.org/examples/models/gltf/DamagedHelmet/glTF-Binary/DamagedHelmet.glb');
        });
    </script>
</body>
</html>
